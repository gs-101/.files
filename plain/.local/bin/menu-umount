#!/usr/bin/env -S guix shell --verbosity=0 coreutils gawk libnotify procps util-linux-with-udev -- sh
# See https://www.youtube.com/watch?v=YOpeXETS2z0
# TODO: Add hyprlauncher and television as dependencies once they're available for Guix.

set -eu

# Helpers.

menu() {
  prompt="$1"

  if pidof hyprlauncher >/dev/null 2>&1; then
    # Hyprlauncher doesn't support prompts. :(
    hyprlauncher --dmenu
  else
    tv --input-prompt "$prompt"
  fi
}

# Main script.

exclusion_regex="(/boot|/home|/)$"
drives=$(lsblk -lp | awk '$6 == "part" && $7 != ""' | grep -v -E "$exclusion_regex" | awk '{print $1, "(" $4 ")", "on", $7}')

if [ -z "$drives" ]; then
  exit 1
fi

chosen=$(echo "$drives" | menu "Unmount which drive?" | awk '{print $1}')

sudo umount "$chosen"

# fnott is kind of an optional dependency.
if pidof fnott >/dev/null 2>&1; then
  notify-send "$chosen unmounted."
fi
