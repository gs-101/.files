#!/usr/bin/env -S guix shell --verbosity=0 coreutils fd gawk libnotify procps util-linux-with-udev -- sh
# See https://www.youtube.com/watch?v=YOpeXETS2z0
# TODO: Add hyprlauncher and television as dependencies once they're available for Guix.

set -eu

# Helpers.

menu() {
  prompt="$1"

  if pidof hyprlauncher >/dev/null 2>&1; then
    # Hyprlauncher doesn't support prompts. :(
    hyprlauncher --dmenu
  else
    tv --input-prompt "$prompt"
  fi
}

# Main script.

mountable=$(lsblk -lp | awk '$6 == "part" && $7 == "" {print $1, "(" $4 ")"}')

if [ -z "$mountable" ]; then
  exit 1
fi

chosen=$(echo "$mountable" | menu "Mount which drive?" | awk '{print $1}')

if [ -z "$chosen" ]; then
  exit 0
fi

# Try to automatically mount the drive if it's in /etc/fstab.
if sudo mount "$chosen" 2>/dev/null; then
  exit 0
fi

dirs=$(fd .  \
          /home \
          /media \
          /mnt \
          /mount \
          --absolute-path \
          --type directory \
          --type empty \
          --max-depth 3 \
          2>/dev/null)
mount_point=$(echo "$dirs" | menu "Type in mount point.")

if [ -z "$mount_point" ]; then
  exit 1
fi

if [ ! -d "$mount_point" ]; then
  mkdiryn=$(printf "Yes\nNo\n" | menu "$mount_point does not exist. Create it?")

  if [ "$mkdiryn" = "Yes" ]; then
    sudo mkdir -p "$mount_point"
  else
    exit 1
  fi
fi

sudo mount "$chosen" "$mount_point"

# fnott is kind of an optional dependency.
if pidof fnott >/dev/null 2>&1; then
  notify-send "$chosen mounted to $mount_point."
fi
