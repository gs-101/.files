#!/usr/bin/env -S guix shell --verbosity=0 coreutils curl jq sed -- sh

set -eu

script_name="${0##*/}"

# Usage.

usage() {
  echo "Usage: $script_name [-i] [LOGO]" >&2
}

if [ "$#" -lt 1 ]; then
  usage
  exit 1
fi

# Helpers.

menu() {
  prompt="$1"

  if pidof hyprlauncher >/dev/null 2>&1; then
    # Hyprlauncher doesn't support prompts. :(
    hyprlauncher --dmenu
  else
    tv --input-prompt "$prompt"
  fi
}

fetch_and_cache() {
  local_file="$1"
  url="https://raw.githubusercontent.com/fastfetch-cli/fastfetch/refs/heads/dev/src/logo/ascii/$logo.txt"
  temp_file="${local_file}.tmp"

  if curl --fail --silent --output "$temp_file" "$url"; then
    mv "$temp_file" "$local_file"
  else
    # "-f" makes the command faster in case the file wasn't created.
    rm -f "$temp_file"
    echo "$script_name: $logo: Failed to fetch logo" >&2
    exit 1
  fi
}

# Argument parsing.

if [ "$1" = "-i" ]; then
  logo=$(curl -s https://api.github.com/repos/fastfetch-cli/fastfetch/contents/src/logo/ascii | \
           jq -r ".[] | .name" | \
           sed "s/.txt//" | \
           menu "Pick a logo"
      )
  if [ -z "$logo" ]; then
    echo "$script_name: No selection made" >&2
    exit 1
  fi
elif [ "$1" = "-h" ]; then
  usage
  exit 0
else
  logo="${1##*/}"
fi

# Variables.

xdg_cache="${XDG_CACHE_HOME:-$HOME/.cache}"
cache_dir="$xdg_cache/$script_name"
cache_file="$cache_dir/$logo.txt"

# Main script.

mkdir -p "$cache_dir"

if [ ! -f "$cache_file" ]; then
  fetch_and_cache "$cache_file"
fi

cat "$cache_file"
printf "\n"
