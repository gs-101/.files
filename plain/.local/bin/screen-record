#!/usr/bin/env -S guix shell ffmpeg libnotify procps slurp wf-recorder wl-clipboard -- sh
# See https://axlefublr.github.io/screen-recording/
# See https://github.com/ammen99/wf-recorder

set -eu

script_name="${0##*/}"

# Usage.

usage() {
  echo "Usage: $script_name [-ag] [FILE_NAME]"
}

# Argument parsing.

audio=false
geometry=false

while getopts "ag" option; do
  case $option in
    a)
      audio=true;
      ;;
    g)
      geometry=true
      ;;
    *)
      usage >&2
      exit 1
      ;;
  esac
done

shift $((OPTIND - 1))

# Variables.

base_name="${1:-video}"
file_name="${base_name##*/}"
lock_dir="${XDG_RUNTIME_DIR:-/tmp}"
lock_file="$lock_dir/$script_name-${file_name}.lock"
waybar_indicator_file="$lock_dir/waybar-screen-record-indicator"

# Helpers.

waybar_recording() {
  if [ -e "$waybar_indicator_file" ]; then
    echo "ó°‘Š" > "$waybar_indicator_file"
  fi
}

waybar_stopped_recording() {
  if [ -e "$waybar_indicator_file" ]; then
    echo > "$waybar_indicator_file"
  fi
}

record() {
  set -- --no-damage --overwrite -f "$file_name.mp4"

  if [ "$audio" = true ]; then
    set -- "$@" --audio
  fi

  if [ "$geometry" = true ]; then
    region=$(slurp)

    set -- "$@" --geometry "$region"
  fi

  waybar_recording
  wf-recorder "$@" &
  rec_pid=$!
  echo "$rec_pid" > "$lock_file"
  wait "$rec_pid"
  # Since wf-recorder runs continuously, this only runs after the toggle.
  rm -f "$lock_file"
  wl-copy --type text/uri-list "file://$PWD/$file_name.mp4"
}

# Main script.

## Toggle logic.

if [ -f "$lock_file" ]; then
  target_pid=$(cat "$lock_file")

  if kill -0 "$target_pid"; then
    kill -INT "$target_pid"
    waybar_stopped_recording
    exit 0
  else
    # This indicates the lock exists, but the process is dead, so we can
    # start recording.
    rm -f "$lock_file"
  fi
fi

## Main logic.

record

notify-send \
  --app-name="$script_name" \
  "Recording Saved" \
  "Finished recording \"$file_name.mp4\"."
