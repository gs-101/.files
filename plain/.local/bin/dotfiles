#!/bin/sh

set -eu

script_name="${0##*/}"

# Usage.

usage() {
  echo "Unknown command: ${1:-}" >&2
  echo "Usage: $script_name all | gc | home | image | nuke | reload | system | update" >&2
  exit 1
}

# Variables.

dotfiles="$HOME/.files"
module_files="$dotfiles/gs-101"
plain_files="$dotfiles/plain"
nix_home_manager_files="$plain_files/.config/home-manager"
host_name="$(hostname)"

# Helpers.

run_guix_home() {
  guix home reconfigure -L "$dotfiles" "$module_files/home/$host_name.scm" "$@"
}

# Commands.

update() {
  channel_file="$plain_files/.config/guix/channels.scm"
  guix_commit_message="chore(channels.scm): update channels"
  nix_commit_message="chore(flake.lock): update flake"

  guix pull --channels="$plain_files/.config/guix/channels-list.scm"
  guix pull --news
  guix describe --format=channels >"$channel_file"

  # Use a subshell so "cd" doesn't affect the rest of the script.
  (
    cd "$dotfiles"
    git add "$channel_file"
    git commit --message="$guix_commit_message"
  )

  nix flake update \
    --flake "$nix_home_manager_files" \
    --commit-lock-file \
    --commit-lockfile-summary "$nix_commit_message"
}

gc() {
  guix gc
  nix-collect-garbage
}

nuke() {
  guix gc -d
  nix-collect-garbage -d
}

system() {
  sudo guix system reconfigure -L "$dotfiles" "$module_files/system/$host_name.scm"
}

home() {
  run_guix_home --fallback
  home-manager switch --flake "$nix_home_manager_files"

  if [ "${XDG_CURRENT_DESKTOP:-}" = "Hyprland" ]; then
    hyprctl reload
  fi
}

reload() {
  run_guix_home --no-substitutes
  home-manager switch --flake "$nix_home_manager_files" --no-substitute

  if [ "${XDG_CURRENT_DESKTOP:-}" = "Hyprland" ]; then
    hyprctl reload
  fi
}

image() {
  guix system image \
    --image-type=iso9660 \
    --root="image.iso" \
    -L "$dotfiles" \
    "$module_files/system/image.scm" \
    --fallback
}

all() {
  update
  system
  home
}

case "${1:-all}" in
update)
  update
  ;;
gc)
  gc
  ;;
nuke)
  nuke
  ;;
system)
  system
  ;;
home)
  home
  ;;
reload)
  reload
  ;;
image)
  image
  ;;
all)
  all
  ;;
*)
  usage "${1:-}"
  ;;
esac
