#!/usr/bin/env -S guix shell coreutils fd glib:bin gsettings-desktop-schemas libnotify matugen swww -- sh

set -eu

script_name="${0##*/}"

# Usage.

usage() {
  echo "Usage: $script_name light | dark"
}

# Helpers.

gsettings_set() {
  key="$1"
  value="$2"

  gsettings set org.gnome.desktop.interface "$key" "$value"
}

# Main script.

set_theme() {
  theme="$1"
  random_wallpaper=$(fd -a -e png . "$HOME/Pictures/wallpapers" | shuf -n 1)
  file_name=$(basename "$random_wallpaper")

  if [ "$theme" = "light" ]; then
    greeting_time="Morning"
    gtk_theme="adw-gtk3"
    color_scheme="default"
  elif [ "$theme" = "dark" ]; then
    greeting_time="Night"
    gtk_theme="adw-gtk3-dark"
    color_scheme="prefer-dark"
  else
    usage "$theme"
  fi

  matugen image "$random_wallpaper" --mode "$theme"
  gsettings_set "gtk-theme" "$gtk_theme"
  gsettings_set "color-scheme" "$color_scheme"

  notify-send \
    --app-name="darkman" \
    "Good $greeting_time" \
    "Switching to $theme using \"$file_name\" as the wallpaper."
}

# Argument parsing.

case "${1:-main}" in
  light)
    set_theme light
    ;;
  dark)
    set_theme dark
    ;;
  *)
    echo "Unknown command: ${1:-}" >&2
    usage >&2
    exit 1
    ;;
esac
