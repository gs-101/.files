#!/usr/bin/env -S guix shell coreutils fd glib:bin gsettings-desktop-schemas libnotify matugen swww -- sh

set -eu

script_name="${0##*/}"

usage() {
  echo "Unknown command: ${1:-}" >&2
  echo "Usage: $script_name light | dark" >&2
  exit 1
}

gsettings_set() {
  key="$1"
  value="$2"

  gsettings set org.gnome.desktop.interface "$key" "$value"
}

set_theme() {
  theme="$1"
  random_wallpaper=$(fd -a -e png . "$HOME/Pictures/wallpapers" | shuf -n 1)
  file_name=$(basename "$random_wallpaper")

  if [ "$theme" = "light" ]; then
    greeting_time="Morning"
    gtk_theme="adw-gtk3"
    prefer_dark="0"
  elif [ "$theme" = "dark" ]; then
    greeting_time="Night"
    gtk_theme="adw-gtk3-dark"
    prefer_dark="1"
  else
    usage "$theme"
  fi

  matugen image "$random_wallpaper" -m "$theme"
  gsettings_set "color-scheme" "prefer-$theme"
  gsettings_set "gtk-theme" "$gtk_theme"
  gsettings_set "gtk-application-prefer-dark-theme" "$prefer_dark"

  if pidof fnott; then
    notify-send \
      --app-name="darkman" \
      "Good $greeting_time" \
      "Switching to $theme using \"$file_name\" as the wallpaper."
  fi
}

case "${1:-main}" in
  light)
    set_theme light
    ;;
  dark)
    set_theme dark
    ;;
  *)
    usage "${1:-}"
    ;;
esac
