#!/usr/bin/env -S guix shell bash coreutils findutils gawk libnotify procps util-linux-with-udev -- bash
# See https://www.youtube.com/watch?v=YOpeXETS2z0
# Add hyprlauncher and television as dependencies when they're packaged in Guix.

mountable=$(lsblk -lp | awk '$6 == "part" && $7 == "" {print $1, "(" $4 ")"}')
[[ -z "$mountable" ]] && exit 1

# Indicates we're in a graphical environment.
if pgrep -x hyprlauncher; then
  chosen=$(echo "$mountable" | hyprlauncher --dmenu | awk '{print $1}')
  [[ -z "$chosen" ]] && exit 0
  sudo mount "$chosen" && exit 0

  dirs=$(find /mnt /media /mount /home -type d -empty -maxdepth 3 2>/dev/null)
  mount_point=$(echo "$dirs" | hyprlauncher --dmenu)
  [[ -z "$mount_point" ]] && exit 1
  if [[ ! -d "$mount_point" ]]; then
    mkdiryn=$(echo -e "No\nYes" | hyprlauncher --dmenu)
    [[ "$mkdiryn" = Yes ]] && sudo mkdir -p "$mount_point"
  fi
else
  chosen=$(echo "$mountable" | tv | awk '{print $1}')
  [[ -z "$chosen" ]] && exit 0
  sudo mount "$chosen" && exit 0

  dirs=$(find /mnt /media /mount /home -type d -empty -maxdepth 3 2>/dev/null)
  mount_point=$(echo "$dirs" | tv)
  [[ -z "$mount_point" ]] && exit 1
  if [[ ! -d "$mount_point" ]]; then
    mkdiryn=$(echo -e "No\nYes" | tv)
    [[ "$mkdiryn" = Yes ]] && sudo mkdir -p "$mount_point"
  fi
fi

sudo mount $chosen $mount_point
# fnott is kind of an optional dependency.
pgrep -x fnott && notify-send "$chosen mounted to $mount_point."

# drives=$(lsblk -nlp | awk 'NF > 6 && !/(\/|\/boot|\/home)$/ {print $, "(" $4 ")"}'
